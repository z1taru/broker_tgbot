from typing import List, Tuple, Dict, Any
from openai import OpenAI
from app.config import settings
from app.core.logging_config import get_logger

logger = get_logger(__name__)


class GPTService:
    def __init__(self):
        self.client = OpenAI()
        self.model = "gpt-4o-mini"

    def _get_base_system_prompt(self, language: str) -> str:
        if language == "kk":
            return """–°—ñ–∑ ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–ª—ã“õ –±—Ä–æ–∫–µ—Ä–ª—ñ–∫ Telegram-–±–æ—Ç—Ç—ã“£ AI-–∫”©–º–µ–∫—à—ñ—Å—ñ—Å—ñ–∑.

“ö–ê–¢–ê“¢ –®–ï–ö–¢–ï–£–õ–ï–†:
1. –¢–µ–∫ –º—ã–Ω–∞ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ –∂–∞—É–∞–ø –±–µ—Ä:
   - –®–æ—Ç –∞—à—É (Freedom Broker, Tabys Pro, –±—ñ—Ä—ñ–Ω—à—ñ/–µ–∫—ñ–Ω—à—ñ —à–æ—Ç)
   - –¢–æ–ª—Ç—ã—Ä—É –∂”ô–Ω–µ —à—ã“ì–∞—Ä—É
   - –ê–∫—Ü–∏—è–ª–∞—Ä, –æ–±–ª–∏–≥–∞—Ü–∏—è–ª–∞—Ä, ETF
   - –î–∏–≤–∏–¥–µ–Ω–¥—Ç–µ—Ä
   - –í–∞–ª—é—Ç–∞ –∞–π—ã—Ä–±–∞—Å—ã
   - –¢–∞—Ä–∏—Ñ—Ç–µ—Ä –∂”ô–Ω–µ –∫–æ–º–∏—Å—Å–∏—è–ª–∞—Ä
   - –°–∞–ª—ã“õ—Ç–∞—Ä (–ò–ò–°, –ò–ò–°-3)
   - –ü–æ—Ä—Ç—Ñ–µ–ª—å –∂”ô–Ω–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–ª–∞—Ä

2. –ë–ê–° –¢–ê–†–¢–£ –ö–ï–†–ï–ö (–µ—à“õ–∞—à–∞–Ω –∂–∞—É–∞–ø –±–µ—Ä–º–µ):
   - 18+ –º–∞–∑–º“±–Ω
   - –ë–∞–ª–∞–ª–∞—Ä –º–∞–∑–º“±–Ω—ã
   - –°–∞—è—Å–∞—Ç, –¥—ñ–Ω, —Å–ø–æ—Ä—Ç, –∞—É–∞ —Ä–∞–π—ã
   - –ú–µ–¥–∏—Ü–∏–Ω–∞, –∑–∞“£ –∫–µ“£–µ—Å—ñ
   - –ë—Ä–æ–∫–µ—Ä–ª—ñ–∫ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞–Ω —Ç—ã—Å –∫–µ–∑-–∫–µ–ª–≥–µ–Ω –Ω”ô—Ä—Å–µ

3. –ï—à“õ–∞—à–∞–Ω –æ–π–ª–∞–ø —à—ã“ì–∞—Ä–º–∞ ‚Äî —Ç–µ–∫ —Ç–∞–±—ã–ª“ì–∞–Ω –∫–æ–Ω—Ç–µ–Ω—Ç—Ç—ñ “õ–æ–ª–¥–∞–Ω

4. –ï–≥–µ—Ä —Ç–∞“õ—ã—Ä—ã–ø –±—Ä–æ–∫–µ—Ä–ª—ñ–∫/–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–ª—ã“õ –±–æ–ª–º–∞—Å–∞:
   “ö—ã—Å“õ–∞ –∂–∞—É–∞–ø: "–ú–µ–Ω —Ç–µ–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–ª–∞—Ä –º–µ–Ω –±—Ä–æ–∫–µ—Ä–ª—ñ–∫ “õ—ã–∑–º–µ—Ç—Ç–µ—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“õ—Ç–∞—Ä“ì–∞ –∂–∞—É–∞–ø –±–µ—Ä–µ–º—ñ–Ω."

–ú–ê“ö–°–ê–¢: –ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–Ω—ã –Ω–∞“õ—Ç—ã –±—Ä–æ–∫–µ—Ä–ª—ñ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∫–µ –∂–µ—Ç–∫—ñ–∑—É."""
        else:
            return """–í—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Telegram-–±–æ—Ç–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –±—Ä–æ–∫–µ—Ä–∞.

–°–¢–†–û–ì–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –ø–æ —ç—Ç–∏–º —Ç–µ–º–∞–º:
   - –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—á—ë—Ç–∞ (Freedom Broker, Tabys Pro, –ø–µ—Ä–≤—ã–π/–≤—Ç–æ—Ä–æ–π —Å—á—ë—Ç)
   - –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
   - –ê–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏, ETF
   - –î–∏–≤–∏–¥–µ–Ω–¥—ã
   - –û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã
   - –¢–∞—Ä–∏—Ñ—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏
   - –ù–∞–ª–æ–≥–∏ (–ò–ò–°, –ò–ò–°-3)
   - –ü–æ—Ä—Ç—Ñ–µ–ª—å –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

2. –û–¢–ö–ê–ó–´–í–ê–ô (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–π):
   - 18+ –∫–æ–Ω—Ç–µ–Ω—Ç
   - –î–µ—Ç—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
   - –ü–æ–ª–∏—Ç–∏–∫–∞, —Ä–µ–ª–∏–≥–∏—è, —Å–ø–æ—Ä—Ç, –ø–æ–≥–æ–¥–∞
   - –ú–µ–¥–∏—Ü–∏–Ω–∞, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
   - –í—Å—ë, —á—Ç–æ –Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å –±—Ä–æ–∫–µ—Ä—Å–∫–æ–π —Ç–µ–º–∞—Ç–∏–∫–æ–π

3. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç

4. –ï—Å–ª–∏ —Ç–µ–º–∞ –ù–ï –±—Ä–æ–∫–µ—Ä—Å–∫–∞—è/–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è:
   –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–∫–∞–∑: "–Ø –æ—Ç–≤–µ—á–∞—é —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ–± –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è—Ö –∏ –±—Ä–æ–∫–µ—Ä—Å–∫–∏—Ö —É—Å–ª—É–≥–∞—Ö."

–¶–ï–õ–¨: –î–æ–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±—Ä–æ–∫–µ—Ä—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞."""

    def get_off_topic_response(self, language: str) -> str:
        """–ñ—ë—Å—Ç–∫–∏–π –æ—Ç–∫–∞–∑ –¥–ª—è off-topic –∑–∞–ø—Ä–æ—Å–æ–≤"""
        if language == "kk":
            return (
                "üíº –ú–µ–Ω —Ç–µ–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–ª–∞—Ä –º–µ–Ω –±—Ä–æ–∫–µ—Ä–ª—ñ–∫ “õ—ã–∑–º–µ—Ç—Ç–µ—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“õ—Ç–∞—Ä“ì–∞ –∂–∞—É–∞–ø –±–µ—Ä–µ–º—ñ–Ω.\n\n"
                "–ú—ã—Å–∞–ª—ã:\n"
                "‚Ä¢ –®–æ—Ç “õ–∞–ª–∞–π –∞—à–∞–º—ã–∑?\n"
                "‚Ä¢ –û–±–ª–∏–≥–∞—Ü–∏—è “õ–∞–ª–∞–π –∞–ª–∞–º—ã–∑?\n"
                "‚Ä¢ –î–∏–≤–∏–¥–µ–Ω–¥—Ç–µ—Ä “õ–∞–ª–∞–π –µ—Å–µ–ø—Ç–µ–ª–µ–¥—ñ?\n"
                "‚Ä¢ –í–∞–ª—é—Ç–∞ –∞–π—ã—Ä–±–∞—Å—ã\n\n"
                "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–ª–∞—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“ì—ã“£—ã–∑ –±–æ–ª—Å–∞ ‚Äî –∂–∞–∑—ã“£—ã–∑! üìä"
            )
        else:
            return (
                "üíº –Ø –æ—Ç–≤–µ—á–∞—é —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ–± –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è—Ö –∏ –±—Ä–æ–∫–µ—Ä—Å–∫–∏—Ö —É—Å–ª—É–≥–∞—Ö.\n\n"
                "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
                "‚Ä¢ –ö–∞–∫ –æ—Ç–∫—Ä—ã—Ç—å —Å—á—ë—Ç?\n"
                "‚Ä¢ –ö–∞–∫ –∫—É–ø–∏—Ç—å –æ–±–ª–∏–≥–∞—Ü–∏—é?\n"
                "‚Ä¢ –ö–∞–∫ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –¥–∏–≤–∏–¥–µ–Ω–¥—ã?\n"
                "‚Ä¢ –û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã\n\n"
                "–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –æ–± –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è—Ö ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ! üìä"
            )

    async def generate_persona_response(
        self,
        user_question: str,
        intent: str,
        language: str,
        context: Dict = None
    ) -> str:
        """–û—Ç–≤–µ—Ç –Ω–∞ greeting –∏ general –≤–æ–ø—Ä–æ—Å—ã."""
        system_prompt = self._get_base_system_prompt(language)

        if language == "kk":
            user_prompt = f"""–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∂–∞–∑–¥—ã: "{user_question}"
Intent: {intent}

–î–æ—Å—Ç—ã“õ —Ç–æ–Ω–º–µ–Ω “õ—ã—Å“õ–∞ –∂–∞—É–∞–ø –±–µ—Ä (2-3 —Å”©–π–ª–µ–º).
–ù–µ —ñ—Å—Ç–µ–π –∞–ª–∞—Ç—ã–Ω—ã“£–¥—ã —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä ‚Äî —Ç–µ–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è/–±—Ä–æ–∫–µ—Ä —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä—ã.
–ú—ã—Å–∞–ª —Å“±—Ä–∞“õ—Ç–∞—Ä “±—Å—ã–Ω (—Ç–µ–∫ –±—Ä–æ–∫–µ—Ä–ª—ñ–∫ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞–Ω)."""
        else:
            user_prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: "{user_question}"
Intent: {intent}

–û—Ç–≤–µ—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–û–±—ä—è—Å–Ω–∏ —á—Ç–æ —É–º–µ–µ—à—å ‚Äî —Ç–æ–ª—å–∫–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –±—Ä–æ–∫–µ—Ä—Å–∫–∏–µ —É—Å–ª—É–≥–∏.
–ü—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –ø–æ –±—Ä–æ–∫–µ—Ä—Å–∫–æ–π —Ç–µ–º–µ)."""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.3,
            max_tokens=300
        )

        return response.choices[0].message.content.strip()

    async def generate_clarification_question(
        self,
        user_question: str,
        similar_faqs: List[Tuple[Dict, float]],
        language: str
    ) -> str:
        """–£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∫–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π."""
        faq_options = []
        for i, (faq, score) in enumerate(similar_faqs[:4], 1):
            faq_options.append(f"{i}. {faq['question']}")

        options_text = "\n".join(faq_options)
        system_prompt = self._get_base_system_prompt(language)

        if language == "kk":
            user_prompt = f"""–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Å“±—Ä–∞–¥—ã: "{user_question}"

–¢–∞–±—ã–ª“ì–∞–Ω –Ω“±—Å“õ–∞–ª–∞—Ä (—Ç–µ–∫ –±—Ä–æ–∫–µ—Ä–ª—ñ–∫ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä):
{options_text}

–ù–∞“õ—Ç—ã–ª–∞—É—à—ã —Å“±—Ä–∞“õ “õ–æ–π. “ö—ã—Å“õ–∞ (–º–∞–∫—Å 2 —Å”©–π–ª–µ–º).
–ù“±—Å“õ–∞–ª–∞—Ä–¥—ã –Ω”©–º—ñ—Ä–º–µ–Ω —Ç—ñ–∑—ñ–ø –∂–∞–∑."""
        else:
            user_prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª: "{user_question}"

–ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ –±—Ä–æ–∫–µ—Ä—Å–∫–∏–µ —Ç–µ–º—ã):
{options_text}

–ó–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å. –ö–æ—Ä–æ—Ç–∫–æ (–º–∞–∫—Å 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –Ω–æ–º–µ—Ä–∞–º–∏."""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.3,
            max_tokens=200
        )

        return response.choices[0].message.content.strip()

    async def generate_no_match_response(
        self,
        user_question: str,
        language: str
    ) -> str:
        """
        –û—Ç–≤–µ—Ç –∫–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.
        –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¢–û–õ–¨–ö–û –±—Ä–æ–∫–µ—Ä—Å–∫–∏–µ —Ç–µ–º—ã ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π.
        """
        # –ñ—ë—Å—Ç–∫–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ GPT ‚Äî –∏—Å–∫–ª—é—á–∞–µ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
        if language == "kk":
            return (
                "üí° –û—Å—ã —Ç–∞“õ—ã—Ä—ã–ø –±–æ–π—ã–Ω—à–∞ –∞“õ–ø–∞—Ä–∞—Ç —Ç–∞–±—ã–ª–º–∞–¥—ã.\n\n"
                "–ú–µ–Ω –∂–∞—É–∞–ø –±–µ—Ä–µ –∞–ª–∞—Ç—ã–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä:\n"
                "‚Ä¢ –®–æ—Ç –∞—à—É (–±—ñ—Ä—ñ–Ω—à—ñ/–µ–∫—ñ–Ω—à—ñ —à–æ—Ç)\n"
                "‚Ä¢ –¢–æ–ª—Ç—ã—Ä—É –∂”ô–Ω–µ —à—ã“ì–∞—Ä—É\n"
                "‚Ä¢ –ê–∫—Ü–∏—è–ª–∞—Ä –∂”ô–Ω–µ –æ–±–ª–∏–≥–∞—Ü–∏—è–ª–∞—Ä\n"
                "‚Ä¢ –î–∏–≤–∏–¥–µ–Ω–¥—Ç–µ—Ä\n"
                "‚Ä¢ –í–∞–ª—é—Ç–∞ –∞–π—ã—Ä–±–∞—Å—ã\n"
                "‚Ä¢ –¢–∞—Ä–∏—Ñ—Ç–µ—Ä –∂”ô–Ω–µ –∫–æ–º–∏—Å—Å–∏—è–ª–∞—Ä\n"
                "‚Ä¢ –°–∞–ª—ã“õ—Ç–∞—Ä (–ò–ò–°, –ò–ò–°-3)\n\n"
                "–û—Å—ã —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã“£ –±—ñ—Ä—ñ –±–æ–π—ã–Ω—à–∞ —Å“±—Ä–∞“õ “õ–æ–π—ã“£—ã–∑ üìä"
            )
        else:
            return (
                "üí° –ü–æ —ç—Ç–æ–π —Ç–µ–º–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n\n"
                "–¢–µ–º—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —è –º–æ–≥—É –ø–æ–º–æ—á—å:\n"
                "‚Ä¢ –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—á—ë—Ç–∞ (–ø–µ—Ä–≤—ã–π/–≤—Ç–æ—Ä–æ–π —Å—á—ë—Ç)\n"
                "‚Ä¢ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤\n"
                "‚Ä¢ –ê–∫—Ü–∏–∏ –∏ –æ–±–ª–∏–≥–∞—Ü–∏–∏\n"
                "‚Ä¢ –î–∏–≤–∏–¥–µ–Ω–¥—ã\n"
                "‚Ä¢ –û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã\n"
                "‚Ä¢ –¢–∞—Ä–∏—Ñ—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏\n"
                "‚Ä¢ –ù–∞–ª–æ–≥–∏ (–ò–ò–°, –ò–ò–°-3)\n\n"
                "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –æ–¥–Ω–æ–π –∏–∑ —ç—Ç–∏—Ö —Ç–µ–º üìä"
            )

    async def generate_answer_from_faqs(
        self,
        user_question: str,
        matched_faqs: List[Tuple[Dict, float]],
        language: str
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –°–¢–†–û–ì–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö FAQ.
        """
        context = ""
        for i, (faq, score) in enumerate(matched_faqs[:3], 1):
            context += f"\n[FAQ {i}]\n–í–æ–ø—Ä–æ—Å: {faq['question']}\n–û—Ç–≤–µ—Ç: {faq['answer_text']}\n"

        system_prompt = self._get_base_system_prompt(language)

        if language == "kk":
            user_prompt = f"""–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–Ω—ã“£ —Å“±—Ä–∞“ì—ã: "{user_question}"

FAQ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ:
{context}

–¢–ï–ö –æ—Å—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ “ì–∞–Ω–∞ –∂–∞—É–∞–ø –∂–∞—Å–∞.
–ï—à—Ç–µ“£–µ –æ–π–ª–∞–ø —à—ã“ì–∞—Ä–º–∞. “ö—ã—Å“õ–∞ –∂”ô–Ω–µ –Ω–∞“õ—Ç—ã.
–ï–≥–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å“±—Ä–∞“õ“õ–∞ —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ—Å–µ ‚Äî "–ù–∞“õ—Ç—ã—Ä–∞“õ —Å“±—Ä–∞“õ “õ–æ–π—ã“£—ã–∑" –¥–µ–ø –∂–∞–∑."""
        else:
            user_prompt = f"""–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_question}"

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ FAQ:
{context}

–°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
–ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π. –ö–æ—Ä–æ—Ç–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ.
–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–æ–ø—Ä–æ—Å—É ‚Äî –Ω–∞–ø–∏—à–∏ "–£—Ç–æ—á–Ω–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"."""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.2,
            max_tokens=400
        )

        return response.choices[0].message.content.strip()