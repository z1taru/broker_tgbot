# api/app/ai/gpt_service.py
from typing import List, Tuple, Dict, Any
import httpx
from openai import OpenAI
from app.config import settings
from app.core.logging_config import get_logger

logger = get_logger(__name__)


class GPTService:
    def __init__(self):
        self.client = OpenAI()
        self.model = "gpt-4o-mini"
    
    async def generate_persona_response(
        self,
        user_question: str,
        intent: str,
        language: str,
        context: Dict = None
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è "–∂–∏–≤–æ–≥–æ" –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∏–º–µ–Ω–∏ –±–æ—Ç–∞-–∫—É—Ä–∞—Ç–æ—Ä–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è greeting, general, off_topic.
        """
        
        system_prompt = self._get_persona_system_prompt(language)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
        context_text = ""
        if context and context.get("similar_faqs"):
            context_text = "\n\n–ü–æ—Ö–æ–∂–∏–µ —Ç–µ–º—ã –≤ –±–∞–∑–µ:\n"
            for faq in context["similar_faqs"][:3]:
                context_text += f"- {faq['question']}\n"
        
        user_prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: "{user_question}"
Intent: {intent}
{context_text}

–û—Ç–≤–µ—Ç—å –∫–∞–∫ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–∫—É—Ä–∞—Ç–æ—Ä. –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è."""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.7,
            max_tokens=300
        )
        
        return response.choices[0].message.content.strip()
    
    async def generate_clarification_question(
        self,
        user_question: str,
        similar_faqs: List[Tuple[Dict, float]],
        language: str
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)"""
        
        faq_options = []
        for i, (faq, score) in enumerate(similar_faqs[:3], 1):
            faq_options.append(f"{i}. {faq['question']}")
        
        options_text = "\n".join(faq_options)
        
        system_prompt = self._get_clarification_system_prompt(language)
        
        user_prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª: "{user_question}"

–ü–æ—Ö–æ–∂–∏–µ –≤–æ–ø—Ä–æ—Å—ã:
{options_text}

–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ö–û–†–û–¢–ö–ò–ô —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å (–º–∞–∫—Å 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç."""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.7,
            max_tokens=150
        )
        
        clarification = response.choices[0].message.content.strip()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–Ω–∏–∑—É
        if language == "kk":
            return f"{clarification}\n\n{options_text}\n\nüí¨ –°–∞–Ω—ã–Ω –∂–∞–∑—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ –Ω–∞“õ—Ç—ã–ª–∞“£—ã–∑"
        else:
            return f"{clarification}\n\n{options_text}\n\nüí¨ –ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"
    
    async def generate_answer_from_faqs(
        self,
        user_question: str,
        matched_faqs: List[Tuple[Dict, float]],
        language: str
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –°–¢–†–û–ì–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö FAQ (–¥–ª—è medium confidence).
        –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é!
        """
        
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ç–æ–ø-3 FAQ
        context = ""
        for i, (faq, score) in enumerate(matched_faqs[:3], 1):
            context += f"\n[FAQ {i}]\n–í–æ–ø—Ä–æ—Å: {faq['question']}\n–û—Ç–≤–µ—Ç: {faq['answer_text']}\n"
        
        system_prompt = self._get_answer_from_context_prompt(language)
        
        user_prompt = f"""–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_question}"

–î–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ FAQ:
{context}

–°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π FAQ."""

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.5,
            max_tokens=400
        )
        
        return response.choices[0].message.content.strip()
    
    # ===== –ü–†–û–ú–ü–¢–´ =====
    
    def _get_persona_system_prompt(self, language: str) -> str:
        if language == "kk":
            return """–°—ñ–∑ - –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–ª—ã“õ AI-–∫—É—Ä–∞—Ç–æ—Ä, —Å—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä–≥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ—Å—ñ–∑.

–°—ñ–∑–¥—ñ“£ –º—ñ–Ω–µ–∑-“õ“±–ª“õ—ã“£—ã–∑:
‚úÖ –î–æ—Å—Ç—ã“õ –∂”ô–Ω–µ “õ–æ–ª–¥–∞—É—à—ã
‚úÖ –ù–∞“õ—Ç—ã –∂”ô–Ω–µ –ø–∞–π–¥–∞–ª—ã
‚úÖ “ö—ã—Å“õ–∞ –∂–∞—É–∞–ø—Ç–∞—Ä (2-3 —Å”©–π–ª–µ–º)
‚úÖ Emoji “õ–æ–ª–¥–∞–Ω—ã“£—ã–∑ (–±—ñ—Ä–∞“õ –∫”©–ø –µ–º–µ—Å)
‚úÖ –ú–Ü–ù–î–ï–¢–¢–Ü: ”ô—Ä–µ–∫–µ—Ç “±—Å—ã–Ω—ã“£—ã–∑

‚ùå –ù–ï –Ü–°–¢–ï–£–ì–ï –ë–û–õ–ú–ê–ô–î–´:
- “ö–∞—Ä–∂—ã–ª—ã“õ –∫–µ“£–µ—Å –±–µ—Ä—É
- –ê“õ–ø–∞—Ä–∞—Ç –æ–π–ª–∞–ø —à—ã“ì–∞—Ä—É
- “∞–∑—ã–Ω –º–æ–Ω–æ–ª–æ–≥
- "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, –º–µ–Ω –±–æ—Ç" –¥–µ—É

–î–æ–º–µ–Ω: –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–ª–∞—Ä, –±—Ä–æ–∫–µ—Ä–ª–µ—Ä, –∞–∫—Ü–∏—è–ª–∞—Ä, –æ–±–ª–∏–≥–∞—Ü–∏—è–ª–∞—Ä.

–ï–≥–µ—Ä –±—ñ–ª–º–µ—Å–µ“£—ñ–∑ - –æ–Ω—ã –º–æ–π—ã–Ω–¥–∞“£—ã–∑ –∂”ô–Ω–µ –∫—É—Ä–∞—Ç–æ—Ä “õ—ã–∑–º–µ—Ç—ñ–Ω–µ –∂—ñ–±–µ—Ä—ñ“£—ñ–∑."""
        else:
            return """–í—ã - AI-–∫—É—Ä–∞—Ç–æ—Ä –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º, –ø–æ–º–æ–≥–∞–µ—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º.

–í–∞—à–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
‚úÖ –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π
‚úÖ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π
‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ emoji (–Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ)
‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ

‚ùå –ù–ï –î–ï–õ–ê–ô–¢–ï:
- –î–∞–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã
- –ü—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –î–ª–∏–Ω–Ω—ã–µ –º–æ–Ω–æ–ª–æ–≥–∏
- –ì–æ–≤–æ—Ä–∏—Ç—å "–∏–∑–≤–∏–Ω–∏—Ç–µ, —è –±–æ—Ç"

–î–æ–º–µ–Ω: –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –±—Ä–æ–∫–µ—Ä—ã, –∞–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏.

–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ - –ø—Ä–∏–∑–Ω–∞–π—Ç–µ —ç—Ç–æ –∏ –Ω–∞–ø—Ä–∞–≤—å—Ç–µ –∫ –∫—É—Ä–∞—Ç–æ—Ä—É."""
    
    def _get_clarification_system_prompt(self, language: str) -> str:
        if language == "kk":
            return """–°—ñ–∑ - —É—Ç–æ—á–Ω—è—é—â–∏–π —Å“±—Ä–∞“õ—Ç–∞—Ä “õ“±—Ä–∞—Å—Ç—ã—Ä—É—à—ã—Å—ã–∑.

“ö–∞“ì–∏–¥–∞–ª–∞—Ä:
- “ö–´–°“ö–ê (–º–∞–∫—Å 2 —Å”©–π–ª–µ–º)
- –î–æ—Å—Ç—ã“õ —Ç–æ–Ω
- –ù–∞“õ—Ç—ã –≤–∞—Ä–∏–∞–Ω—Ç—Ç–∞—Ä “±—Å—ã–Ω—ã“£—ã–∑
- Emoji “õ–æ–ª–¥–∞–Ω—ã“£—ã–∑

–ú—ã—Å–∞–ª: "“ö–∞–π—Å—ã—Å—ã —Å—ñ–∑–≥–µ –∂–∞“õ—ã–Ω—ã—Ä–∞“õ? ü§î" """
        else:
            return """–í—ã - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

–ü—Ä–∞–≤–∏–ª–∞:
- –ö–û–†–û–¢–ö–û (–º–∞–∫—Å 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω
- –ü—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ emoji

–ü—Ä–∏–º–µ—Ä: "–ö–∞–∫–æ–π –∏–∑ —ç—Ç–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –±–ª–∏–∂–µ? ü§î" """
    
    def _get_answer_from_context_prompt(self, language: str) -> str:
        if language == "kk":
            return """–°—ñ–∑ FAQ –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ –∂–∞—É–∞–ø –∂–∞—Å–∞—É—à—ã—Å—ã–∑.

–ú–ê“¢–´–ó–î–´:
- –¢–Ü–õ–Ü –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ–≥—ñ –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã “ì–∞–Ω–∞ “õ–æ–ª–¥–∞–Ω—ã“£—ã–∑
- –ï—à—Ç–µ“£–µ –æ–π–ª–∞–ø —à—ã“ì–∞—Ä–º–∞“£—ã–∑
- –ï–≥–µ—Ä –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑ –±–æ–ª—Å–∞ - –º–æ–π—ã–Ω–¥–∞“£—ã–∑
- “ö—ã—Å“õ–∞ –∂”ô–Ω–µ –Ω–∞“õ—Ç—ã
- –ú“Ø–º–∫—ñ–Ω –±–æ–ª—Å–∞ –±–µ–π–Ω–µ —Å—ñ–ª—Ç–µ–º–µ—Å—ñ–Ω “õ–æ—Å—ã“£—ã–∑"""
        else:
            return """–í—ã - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ FAQ.

–í–ê–ñ–ù–û:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π—Ç–µ
- –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –ø—Ä–∏–∑–Ω–∞–π—Ç–µ —ç—Ç–æ
- –ö–æ—Ä–æ—Ç–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
- –î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ –µ—Å–ª–∏ –µ—Å—Ç—å"""